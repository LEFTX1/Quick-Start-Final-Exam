# 任务交接文档：Redis Cluster Hash字段优化

## 项目背景

**项目名称：** `risk_safe_server`  
**模块：** 自动解绑任务系统（Auto Unbind Worker）  
**交接原因：** Hash字段结构优化，提升性能和功能

## 当前系统架构

### 1. **核心组件**
```
├── ZSet延迟队列：audio:unbind:delay:queue{audio_unbind:gray}
├── Hash任务详情：audio:unbind:task{audio_unbind:gray}:app123:res456
└── Worker处理逻辑：定时取出到期任务并执行解绑
```

### 2. **Hash Tag策略**
```go
// 统一Hash Tag确保Lua脚本执行
tag := "{audio_unbind" + GetGraySuffix() + "}"
// 结果：{audio_unbind:gray} 或 {audio_unbind:all} 等

// 所有相关key落在同一slot，支持Lua脚本原子操作
ZSet: audio:unbind:delay:queue{audio_unbind:gray} -> slot 1234
Hash: audio:unbind:task{audio_unbind:gray}:app123 -> slot 1234
```

### 3. **当前Hash结构（待优化）**
```go
// 问题：整个JSON作为一个字段
HSET taskKey "payload" '{"task_id":"app:res","app_id":"app","resource_id":"res","unbind_time":1234567890,"retry_count":0}'

// 缺点：
// 1. 无法部分更新字段
// 2. 需要JSON序列化/反序列化
// 3. 无法使用Redis原子操作（如HINCRBY）
```

## 优化目标

### 1. **性能提升**
- 避免JSON序列化/反序列化开销
- 支持字段级别的原子操作
- 更好的内存利用

### 2. **功能增强**
- 支持TTL管理
- 支持部分字段更新
- 支持字段级别的监控
- 更好的调试能力

### 3. **保持兼容**
- 维持Lua脚本执行能力
- 保持现有接口不变
- 新增优化方法

## 优化方案

### 1. **新的Hash结构**
```go
// 优化后：字段扁平化
HSET taskKey "task_id" "app:res"
HSET taskKey "app_id" "app"
HSET taskKey "resource_id" "res"
HSET taskKey "unbind_time" "1234567890"
HSET taskKey "retry_count" "0"
HSET taskKey "status" "pending"
HSET taskKey "created_at" "1234567890"
HSET taskKey "updated_at" "1234567890"
```

### 2. **核心方法优化**
```go
// repository/redis_access/delay_queue.go

// 优化前
func (opt *RedisOpts) SaveTaskPayload(ctx context.Context, key string, payload string) error
func (opt *RedisOpts) GetTaskPayload(ctx context.Context, key string) (string, error)

// 优化后
func (opt *RedisOpts) SaveTaskPayload(ctx context.Context, key string, task *entity.UnbindTask) error
func (opt *RedisOpts) GetTaskPayload(ctx context.Context, key string) (*entity.UnbindTask, error)

// 新增方法
func (opt *RedisOpts) SaveTaskPayloadWithTTL(ctx context.Context, key string, task *entity.UnbindTask, ttl time.Duration) error
func (opt *RedisOpts) UpdateTaskField(ctx context.Context, key, field string, value interface{}) error
func (opt *RedisOpts) UpdateTaskFields(ctx context.Context, key string, fields map[string]interface{}) error
func (opt *RedisOpts) IncrementTaskField(ctx context.Context, key, field string, increment int64) error
func (opt *RedisOpts) SetTaskFieldIfNotExists(ctx context.Context, key, field string, value interface{}) error
```

### 3. **Lua脚本优化**
```lua
-- 优化ScheduleRetryIncrement脚本
local script = redis.NewScript(`
    local taskKey = KEYS[1]
    local queueKey = KEYS[2]
    local taskID = ARGV[1]
    local newScore = tonumber(ARGV[2])
    
    -- 原子递增重试次数
    local retryCount = redis.call('HINCRBY', taskKey, 'retry_count', 1)
    
    -- 更新解绑时间和状态
    redis.call('HMSET', taskKey, 
        'unbind_time', math.floor(newScore),
        'status', 'retrying',
        'updated_at', math.floor(newScore)
    )
    
    -- 更新队列分数
    redis.call('ZADD', queueKey, newScore, taskID)
    
    return retryCount
`)
```

## 实施步骤

### 1. **第一阶段：接口优化**
- [ ] 修改 `SaveTaskPayload` 方法，支持结构体参数
- [ ] 修改 `GetTaskPayload` 方法，返回结构体
- [ ] 新增字段操作方法（UpdateTaskField、IncrementTaskField等）

### 2. **第二阶段：Lua脚本优化**
- [ ] 更新 `ScheduleRetryIncrement` 脚本，使用新的字段结构
- [ ] 更新其他相关Lua脚本
- [ ] 测试Lua脚本执行正确性

### 3. **第三阶段：业务代码适配**
- [ ] 修改 `createAutoUnbindTask` 方法
- [ ] 修改重试和延期逻辑
- [ ] 添加TTL管理
- [ ] 更新测试用例

### 4. **第四阶段：测试验证**
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能测试
- [ ] 回归测试

## 关键注意事项

### 1. **Redis Cluster限制**
```go
// 重要：所有相关key必须使用相同的hash tag
// 确保ZSet和Hash落在同一slot，支持Lua脚本执行
tag := "{audio_unbind" + GetGraySuffix() + "}"
```

### 2. **向后兼容性**
```go
// 保持现有接口不变，新增优化方法
// 避免破坏现有功能
// 逐步迁移，平滑过渡
```

### 3. **性能考虑**
```go
// 使用HMSet批量设置字段
// 使用HGetAll批量读取字段
// 合理设置TTL，避免内存泄漏
```

## 测试要点

### 1. **功能测试**
- [ ] 任务创建和保存
- [ ] 任务读取和解析
- [ ] 字段更新操作
- [ ] TTL设置和过期
- [ ] Lua脚本执行

### 2. **性能测试**
- [ ] 批量任务处理性能
- [ ] 内存使用情况
- [ ] Redis操作延迟
- [ ] 并发处理能力

### 3. **异常测试**
- [ ] 网络异常处理
- [ ] Redis连接异常
- [ ] 数据格式异常
- [ ] 并发冲突处理

## 监控指标

### 1. **业务指标**
- 任务创建成功率
- 任务处理成功率
- 任务重试次数分布
- 任务处理延迟

### 2. **技术指标**
- Redis操作延迟
- 内存使用情况
- 错误率统计
- 性能指标监控

## 回滚方案

### 1. **代码回滚**
```bash
# 如果发现问题，可以快速回滚到优化前的版本
git revert <commit-hash>
```

### 2. **数据兼容**
```go
// 保持数据格式兼容，支持新旧两种格式
// 如果新格式有问题，可以临时使用旧格式
```

## 联系方式

**交接人：** AI Assistant  
**交接时间：** 2025-01-20  
**项目负责人：** 待指定  
**技术支持：** 待指定  

## 总结

本次优化将显著提升自动解绑任务系统的性能和功能，同时保持系统的稳定性和兼容性。关键是要确保Redis Cluster的hash tag策略正确，保证Lua脚本的执行能力。

**一句话总结：** 通过Hash字段扁平化优化，在保持Lua脚本执行能力的前提下，提升系统性能和功能，实现平滑升级。



HSET audio:unbind:task{tag} app123:res456 “123456465”