下面是在你现有文档基础上，补充“企业微信机器人告警”相关改动后的完整增量说明（Markdown），只新增/强化与机器人相关的条目，其余结构保持不变。

### 1. 业务流程时序图
- 在 Worker 分支“重试次数达到上限（3次）”时，新增一步：发送企业微信机器人消息告警，然后移出队列并清理任务详情。

### 2. 表改动
保持不变。

### 3. 接口改动
保持不变（机器人告警发生在后台 Worker，不影响接口协议）。

### 4. 后台 Worker 与延迟队列（新增/强化）
- 重试策略（补充）:
  - 查询状态失败：固定 5min 重试
  - 解绑失败：5/15/60min 退避，最多 3 次
  - 新增：当重试次数达到上限(3)时，发送企业微信机器人告警，然后 ZREM 主队列、删除 Hash 详情（当前策略）
- 失败告警（新增）:
  - 触发点：`retry_count >= maxRetry(3)` 的分支
  - 消息渠道：企业微信群“自定义机器人”
  - 文案内容建议：
    - 标题：自动解绑任务失败
    - 关键信息：`app_id`、`resource_id`、`task_id`、`retry_count`、`reason`（固定为“max retry count reached”或最后一次错误简述）、`at`（时间）
- 关键实现文件（新增项）:
  - `util/wework_robot.go`：新增常量 `UnbindRobot`（写死的解绑失败提醒机器人 key）
  - `job/auto_unbind_worker.go`：在 `scheduleRetry` 的“达到上限”分支中调用 `util.SendWeworkMsg`

### 5. 运行与配置
- 运行脚本:
```bash
./risk_safe_server run -c .env.production -s start_auto_unbind_worker
```
- 企业微信机器人配置（新增）:
  - 在企业微信指定群聊添加“自定义机器人”，复制 Webhook 的 `key`
  - 本项目采用“写死 key”方式（无需再配置环境变量）
    - 位置：`util/wework_robot.go`
    - 常量：`UnbindRobot = "1a80237d-a2e5-4d2a-9441-e5bdcb93a6f3"`
  - 环境要求：`APP_ENV=production` 时才会真正发送（`util.SendWeworkMsg` 内部校验）
  - 建议保持机器人“安全设置”为默认（不启用关键词/签名/IP 白名单），否则需对应适配
- 验证：
  - 让某任务连续失败至 3 次，观察群内是否收到告警
  - 也可用 curl 自测 Webhook（POST JSON）

### 6. 常量与规则
保持不变。

### 7. 主要变更文件清单（补充机器人相关）
- `util/wework_robot.go`：新增
  - `const UnbindRobot = "1a80237d-a2e5-4d2a-9441-e5bdcb93a6f3"`（自动解绑失败提醒机器人 key）
  - 已有 `SendWeworkMsg(ctx, key, msg)`：仅在 `APP_ENV=production` 时发送
- `job/auto_unbind_worker.go`：在 `scheduleRetry` 的“达到上限”分支调用：
```go
robotKey := util.UnbindRobot
if robotKey != "" {
  msg := fmt.Sprintf("[自动解绑任务失败]\napp_id=%s\nresource_id=%s\ntask_id=%s\nretry_count=%d\nreason=%s\nat=%s",
    task.AppID, task.ResourceID, taskID, task.RetryCount, "max retry count reached", time.Now().Format("2006-01-02 15:04:05"))
  util.SendWeworkMsg(ctx, robotKey, msg)
}
```

一句话：在“重试三次失败”处新增企业微信机器人告警，key 已写死在 `util.UnbindRobot`，仅 `APP_ENV=production` 时发送；其余接口与数据结构均保持不变。


---------------------------------------------------------------------
### 1. 业务流程时序图（仅改动点）
- 保存配置流程
  -解析与校验 `audit_end_time`（格式 `YYYY-MM-DD HH:MM:SS`）。
  -并发校验（旗舰版校验 + 直播时间查询）。
  -默认解绑时间计算（未传 `audit_end_time` 时）：
    - 有结束时间：结束时间 + 7 天
    - 永久直播（≈10 年）：开始时间 + 30 天
    - 无结束时间：当前时间 + 7 天
  -配置落库包含 `audit_end_time`。
  -非直播中且存在解绑时间 → 创建延迟任务（幂等：覆盖 Hash 与 ZSet 分数）。
- Worker 消费流程
  - **变更**：直播中推迟执行由 24 小时 → 调整为 **1 小时**。
  -重试达到上限（≥3 次）触发企业微信告警，机器人 key 为 `util.UnbindRobot`。

### 2. 表改动（新增字段）
```sql
ALTER TABLE db_ex_risk_safe.t_audio_safe_config
  ADD COLUMN audit_end_time DATETIME NULL COMMENT '自动解绑时间' AFTER stop_words_erase;
```

### 3. 接口改动（仅新增/变更处）

#### ① 保存音频安全配置 `/save_audio_safe_config/1.0.0`【POST】
- 请求参数：**新增** `audit_end_time`
```json
{
  "resource_id": "",
  "audit_switch": 1,
  "strictly_words_audit": 1,
  "strictly_words_erase": 1,
  "stop_words_erase": 0,
  "audit_end_time": "YYYY-MM-DD HH:MM:SS"  // 可选，传参需 ≥ 计划开始时间
}
```
- 响应参数：**新增** `audit_end_time`
```json
{
  "code": 0,
  "msg": "",
  "data": {
    "config_id": 1,
    "audit_switch": 1,
    "strictly_words_audit": 1,
    "strictly_words_erase": 1,
    "stop_words_erase": 0,
    "alive_state": 0,
    "audit_end_time": "2025-08-08 10:00:00"
  }
}
```
- 实现细节（新增/变更）
  - `audit_end_time` 必须为 `YYYY-MM-DD HH:MM:SS`；若传参需 ≥ 直播计划开始时间。
  - 并发校验：旗舰版校验 + `QueryLiveTimeFields`。
  - 默认时间计算规则（见上）。
  - 落库字段包含 `audit_end_time`。
  - 模板绑定/解绑：直播中仅允许修改“暂停消音”，其他变更拒绝。
  - 非直播中且存在解绑时间：创建延迟任务（`taskID=appId:resourceId`，幂等覆盖）。

#### ② 获取音频安全配置 `/get_audio_safe_config/1.0.0`【POST】
- 响应参数：**新增** `audit_end_time`；可选 **新增** `is_permanent_guess`
```json
{
  "code": 0,
  "msg": "",
  "data": {
    "audit_switch": 1,
    "strictly_words_audit": 1,
    "strictly_words_erase": 1,
    "stop_words_erase": 0,
    "alive_state": 0,
    "audit_end_time": "2025-08-08 10:00:00",
    "config_id": 1,
    "is_permanent_guess": false
  }
}
```
- 实现细节（新增）
  - 从表中原样返回 `audit_end_time`（可能为空）。
  - 同步返回 `alive_state`。
  - 可依据计划时长推断 `is_permanent_guess`（≥10 年判真）。

### 4. 后台 Worker 与延迟队列（新增/变更）
- Redis 结构（已落实，说明补充）
  - ZSet：`audio:unbind:delay:queue{suffix}`（member=`taskID`，score=解绑时间戳）
  - Hash：`audio:unbind:task:{taskID}{suffix}`（payload=JSON）
- 任务结构 `UnbindTask`（说明补充）
  - `task_id, app_id, resource_id, unbind_time, updated_at, retry_count, status`
- 处理策略（新增/变更）
  - 原子领取：Lua 脚本 `PopDueTasksAtomic`。
  - 直播中（状态=1/4）：**推迟 1 小时**（由 24 小时下调）。
  - 失败重试：查询失败固定 5min；解绑失败 5/15/60min，最多 3 次。
  - 达到上限（≥3）：**新增** 企业微信告警（`util.SendWeworkMsg(ctx, util.UnbindRobot, msg)`）。

### 5. 常量与规则（调整）
- `PostponeWhenLiveHours = 1`（直播中推迟 1 小时，原 24 小时）。
- 默认解绑时间规则（补充说明，见“保存配置流程”）。
- 入参校验：`audit_end_time` 必须 `YYYY-MM-DD HH:MM:SS` 且 ≥ 计划开始时间。

### 6. 关键文件（仅涉及改动/新增）

- 已按您的要求仅保留“新增/变更”内容，未改动处未重复列出。