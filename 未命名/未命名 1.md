### 1. 业务流程时序图
<=== 红色部分为改动内容 ===>  
暂时无法在飞书文档外展示此内容

### 2. 表改动
- 目标表：`t_audio_safe_config`
- 变更点：新增字段
```sql
ALTER TABLE db_ex_risk_safe.t_audio_safe_config
  ADD COLUMN audit_end_time DATETIME NULL COMMENT '审核结束时间(自动解绑时间)' AFTER stop_words_erase;
```

### 3. 接口改动

#### ① 保存音频安全配置
- 路径：`/save_audio_safe_config/1.0.0`【POST】

- 请求参数：新增解绑时间字段
```json
{
  "resource_id": "",
  "audit_switch": 0,
  "strictly_words_audit": 0,
  "strictly_words_erase": 0,
  "stop_words_erase": 0,
  "audit_end_time": "YYYY-MM-DD HH:MM:SS"
}
```

- 出参：新增解绑时间字段
```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "config_id": 0,
    "audit_switch": 0,
    "strictly_words_audit": 0,
    "strictly_words_erase": 0,
    "stop_words_erase": 0,
    "alive_state": 0,
    "audit_end_time": "2025-08-08 10:00:00"
  }
}
```

- 接口实现细节
  - 参数解析与格式校验：`audit_end_time` 必须为 `YYYY-MM-DD HH:MM:SS`。
  - 并发校验（异步并行）：
    - 校验店铺版本（旗舰版限定），失败直接返回。
    - 查询直播计划时间 `QueryLiveTimeFields(appId, resourceId)`。
    - 若传入 `audit_end_time`：必须不早于直播计划开始时间。
    - 若未传：按规则计算默认时间
      - 有结束时间：默认 结束时间 + 7天
      - 永久直播（≈10年）：默认 开始时间 + 30天
      - 无结束时间兜底：当前时间 + 7天
  - 配置落库：新建/更新 `t_audio_safe_config.audit_end_time`。
  - 模板绑定/解绑：
    - 先幂等解绑旧绑定，再按开关重绑基础/基础+词库/消音。
    - 直播中仅允许修改“暂停消音”，其他变更拒绝。
  - 延迟任务创建（非直播中且存在解绑时间）：
    - `taskID = appId:resourceId` 保存任务详情（Hash: `audio:unbind:task:{taskID}`）
    - 加入 ZSet 队列（`audio:unbind:delay:queue`，score=解绑时间戳）
    - 幂等保证：重复保存只会覆盖任务详情与分数
  - 关键文件：
    - `service/audio_safe_service.go`：`SaveAudioSafeConfig`、`validateAndProcessAuditEndTime`、`BindOrUnbindAuditTemplateBySaveConfig`、`createAutoUnbindTask`
    - `http/entity/audio_audit_entity.go`：新增请求/响应字段
    - `data/model/t_audio_safe_config.go`：新增 `AuditEndTime`

#### ② 获取音频安全配置
- 路径：`/get_audio_safe_config/1.0.0`【POST】

- 请求参数：无改动
- 响应参数：新增解绑时间字段
```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "audit_switch": 0,
    "strictly_words_audit": 0,
    "strictly_words_erase": 0,
    "stop_words_erase": 0,
    "alive_state": 0,
    "audit_end_time": "2025-08-08 10:00:00",
    "config_id": 0,
    "is_permanent_guess": false
  }
}
```

- 接口实现细节
  - 读取 `t_audio_safe_config` 原样返回 `audit_end_time`（无则空）。
  - 同步返回 `alive_state`，便于前端提示。
  - 可按计划时长推断 `is_permanent_guess`（≥10年判真）。

---

### 4. 后台 Worker 与延迟队列（新增）
- Redis 结构：
  - ZSet 队列：`audio:unbind:delay:queue`（member=`taskID`，score=解绑时间戳）
  - Hash 详情：`audio:unbind:task:{taskID}` 保存 `payload`(JSON)
- 任务结构 `UnbindTask`：
  - `task_id、app_id、resource_id、unbind_time、updated_at、retry_count、status`
- 消费流程：
  - 每 30s 轮询；Lua `PopDueTasksAtomic` 原子领取到期任务（防多实例重复）。
  - 读取详情 → `GetLivePushState`：
    - 状态=1/4：推迟24小时（更新 ZSet 分数与 Hash 详情）
    - 其他：逐项解绑；落库关闭开关；`ZREM+DEL` 清理任务
  - 重试策略：
    - 查询状态失败：固定 5min 重试
    - 解绑失败：5/15/60min 退避，最多 3 次
- 幂等策略：
  - `taskID = appId:resourceId`，重复保存只覆盖，不增量插入
- 关键文件：
  - `job/auto_unbind_worker.go`
  - `repository/redis_access/delay_queue.go`
  - `config/job.go`（注册脚本入口 `start_auto_unbind_worker`）

### 5. 运行与配置
- 运行脚本：
```bash
./risk_safe_server run -c .env.production -s start_auto_unbind_worker
```

### 6. 常量与规则
- 默认解绑时间：
  - 永久直播：开始时间 + 30天
  - 普通直播：结束时间 + 7天；无结束时间兜底 当前时间 + 7天
- 入参校验：传入 `audit_end_time` 必须 ≥ 计划开始时间

### 7. 主要变更文件清单
- `data/model/t_audio_safe_config.go`：新增 `AuditEndTime`
- `http/entity/audio_audit_entity.go`：保存/获取配置的请求与响应新增 `audit_end_time`
- `http/constants/audio_safe_constants.go`：新增时间与状态常量
- `repository/redis_access/delay_queue.go`：延迟队列接口+原子领取
- `service/audio_safe_service.go`：入口实现、并发校验、延迟任务创建
- `job/auto_unbind_worker.go`：Worker 核心逻辑
- `config/job.go`：注册脚本入口