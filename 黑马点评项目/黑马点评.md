

# 黑马点评

### **技术架构**: Kratos + Mysql + Redis + gen

**项目简介**: 一个以用户点评为主要内容的本地生活服务平台。实现了登录注册、点赞排行，发布博客，好友关注，优惠卷秒杀，用户签到等功能。用户在通过短信登录之后，可以给别人的帖子点赞，关注别人，也可以查询附近商户，抢优惠卷，在体验完之后可以发表对于该商户的评价贴，同时还实现了用户的签到功能，增加用户的粘性和活跃度

### **我负责的部分**:

- **登录注册**: 对于用户提交的信息使用**Validation**校验，并使用Redis实现验证码、Token的存储
- **热点数据缓存**: Redis+Caffeine实现应用层二级缓存，对于经常访问而且不易变化的数据进行缓存
- **点赞与关注**: 使用**ZSet数据结构**实现了**点赞排行榜**功能，用**Set**以及**集合运算**实现**关注和共同关注**功能，用**Feed流**实现**关注推送**功能
- **优惠券秒杀**: 使用**Lua脚本**解决集群模式下一人一单的问题，**乐观锁**解决库存超卖问题

## **开发中遇到的问题以及最终解决方案**:

1. **Token刷新问题**: 搭建拦截器链，用一级拦截器完成用户的登录校验、并使用二级拦截器解决Token刷新的问题，实现了只要用户在使用就会一直刷新Token的效果
2. **用户权限保存问题**: 通过**context**配合拦截器来进行**Token令牌**的校验，判断当前用户是否处于登录状态，解决了HTTP无状态的问题
3. **Session集群共享问题**: 在集群环境中，服务器之间无法实现会话状态的共享，本项目采用**Redis缓存用户信息**，解决了**原生session**的**痛点**
4. **缓存一致性问题**: 在系统中采用超时剔除和主动更新的缓存更新方案，满足较高的数据一致性需求
5. **ID的规律性明显问题**: 使用自定义分布式ID，通过时间截+序列号+数据库自增的方式实现
6. **秒杀性能优化**: Redis-**Stream流**实现消息队列+Lua脚本实现**异步处理下单**流程，将同步下单改为异步下单，**优化了秒杀业务的流程**，通过JMeter性能压测发现平均耗时从300ms左右降低到100ms左右
7. **高并发问题**: 使用Redis对高频访问的信息进行**缓存预热**，用**布隆过滤器**解决**缓存穿透**，用**随机TTL**解决缓存雪崩，用**逻辑过期**解决**缓存击穿**


